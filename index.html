<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starlight Sanctuary - Emotional Healing Space</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #0c1027, #1a1a3e, #0d1930);
            color: #e6f0ff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            position: relative;
        }
        
        /* 星空背景 */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .star {
            position: absolute;
            background-color: #fff;
            border-radius: 50%;
            animation: twinkle var(--duration, 3s) infinite ease-in-out;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
        
        .header {
            background: rgba(25, 25, 50, 0.6);
            padding: 25px 40px;
            text-align: center;
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-bottom: 30px;
            max-width: 900px;
            width: 100%;
            border: 1px solid rgba(101, 178, 230, 0.3);
            box-shadow: 0 0 30px rgba(101, 178, 230, 0.2);
            position: relative;
            z-index: 10;
        }
        
        h1 {
            font-size: 3.2rem;
            margin-bottom: 15px;
            color: #a8d8ff;
            text-shadow: 0 0 15px rgba(168, 216, 255, 0.7);
            font-family: 'Playfair Display', serif;
            letter-spacing: 1px;
        }
        
        .subtitle {
            font-size: 1.4rem;
            line-height: 1.7;
            max-width: 700px;
            margin: 0 auto;
            color: #c5d5ff;
            font-weight: 300;
        }
        
        .container {
            position: relative;
            max-width: 900px;
            width: 100%;
            height: 65vh;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(101, 178, 230, 0.3);
            background: rgba(15, 25, 45, 0.3);
            margin-bottom: 30px;
            border: 1px solid rgba(101, 178, 230, 0.2);
            z-index: 10;
        }
        
        .camera-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to right, rgba(25, 55, 109, 0.9), rgba(56, 103, 214, 0.7));
            padding: 18px;
            text-align: center;
            font-weight: 600;
            font-size: 1.3rem;
            z-index: 15;
            color: #e6f7ff;
            letter-spacing: 1px;
            font-family: 'Playfair Display', serif;
        }
        
        #camera-feed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror flip */
            z-index: 5;
            opacity: 0.4;
        }
        
        #overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }
        
        .instructions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 30, 60, 0.85);
            padding: 18px;
            text-align: center;
            font-size: 1.2rem;
            z-index: 15;
            color: #b8d4ff;
            font-weight: 500;
            border-top: 1px solid rgba(101, 178, 230, 0.3);
        }
        
        .controls {
            display: flex;
            gap: 20px;
            margin-top: 25px;
            flex-wrap: wrap;
            justify-content: center;
            z-index: 10;
        }
        
        .control-btn {
            background: linear-gradient(135deg, #4a7bc8, #65b2e6);
            color: white;
            border: none;
            padding: 16px 35px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(101, 178, 230, 0.4);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 220px;
            justify-content: center;
            letter-spacing: 1px;
        }
        
        .control-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(101, 178, 230, 0.6);
        }
        
        .control-btn:active {
            transform: translateY(2px);
        }
        
        .star-animation {
            position: absolute;
            z-index: 500;
            opacity: 0;
            pointer-events: none;
            animation: starFloat 3s ease-out forwards;
        }
        
        @keyframes starFloat {
            0% { opacity: 0; transform: translate(0, 0) scale(0.3); }
            20% { opacity: 1; transform: translate(0, -20px) scale(1); }
            80% { opacity: 0.8; }
            100% { opacity: 0; transform: translate(var(--tx, 0), var(--ty, -150px)) scale(0.5); }
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 20, 40, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            backdrop-filter: blur(5px);
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(101, 178, 230, 0.3);
            border-radius: 50%;
            border-top-color: #65b2e6;
            animation: spin 1.5s ease-in-out infinite;
            margin-bottom: 25px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.4rem;
            color: #a8d8ff;
            text-align: center;
            max-width: 80%;
        }
        
        .encouragement {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            color: #ffd700;
            text-align: center;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            opacity: 0;
            transition: opacity 1s ease;
            z-index: 20;
            max-width: 80%;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            font-family: 'Playfair Display', serif;
        }
        
        .moon {
            position: absolute;
            top: 40px;
            right: 40px;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #f9f3d5 0%, #e6d8aa 70%);
            border-radius: 50%;
            box-shadow: 0 0 40px #f9f3d5, 0 0 80px rgba(249, 243, 213, 0.6);
            z-index: 8;
        }
        
        .moon-crater {
            position: absolute;
            background: #d4c69e;
            border-radius: 50%;
        }
        
        .capture-effect {
            position: absolute;
            width: 100px;
            height: 100px;
            border: 4px solid #65b2e6;
            border-radius: 50%;
            box-shadow: 0 0 30px #65b2e6;
            z-index: 25;
            opacity: 0;
            pointer-events: none;
        }
        
        footer {
            margin-top: 20px;
            text-align: center;
            color: #8aa2d8;
            font-size: 1rem;
            z-index: 10;
            max-width: 900px;
        }
        
        @media (max-width: 768px) {
            .container {
                height: 60vh;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .subtitle {
                font-size: 1.1rem;
            }
            
            .control-btn {
                padding: 14px 25px;
                font-size: 1.1rem;
                min-width: 180px;
            }
            
            .moon {
                width: 70px;
                height: 70px;
                top: 20px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- 星空背景 -->
    <div class="stars" id="stars"></div>
    
    <!-- 月亮 -->
    <div class="moon" id="moon"></div>
    
    <div class="header">
        <h1>Starlight Sanctuary</h1>
        <p class="subtitle">Reach out to capture stars of hope. Each carries comforting words to soothe your heart and calm your emotions.</p>
    </div>
    
    <div class="container">
        <div class="camera-header">Starlight Sanctuary - Capture Stars of Comfort</div>
        <div class="loading-overlay" id="loading-overlay">
            <div class="spinner"></div>
            <div class="loading-text">Preparing your sanctuary of peace...</div>
        </div>
        <video id="camera-feed" autoplay playsinline></video>
        <canvas id="overlay-canvas"></canvas>
        <div class="instructions">
            Open your hands to capture comforting stars in the night sky...
        </div>
        
        <!-- 鼓励语显示 -->
        <div class="encouragement" id="encouragement"></div>
    </div>
    
    <div class="controls">
        <button class="control-btn" id="start-btn">
            <span>✨</span> Begin Healing Journey
        </button>
        <button class="control-btn" id="wish-btn">
            <span>🌠</span> Make a Wish
        </button>
        <button class="control-btn" id="reset-btn">
            <span>🔄</span> Renew Sanctuary
        </button>
    </div>
    
    <footer>
        <p>Starlight Sanctuary © 2023 | May every star bring you peace and emotional healing</p>
    </footer>

    <script>
        // 全局变量
        let handTrackingActive = false;
        let lastFrameTime = 0;
        let frameCount = 0;
        let fps = 0;
        let stars = [];
        let capturedStars = 0;
        
        // 情感特定的鼓励语
        const encouragements = {
            general: [
                "Breathe deeply. This moment will pass.",
                "You are stronger than you feel right now.",
                "Your feelings are temporary visitors. Let them in, then let them go.",
                "You've survived every difficult day so far. You will survive this too.",
                "It's okay not to be okay. Be gentle with yourself.",
                "This pain is part of your story, not the whole book.",
                "Your resilience is greater than your struggles.",
                "Healing is not linear. Each step matters.",
                "You are worthy of peace and inner calm.",
                "The night is darkest just before dawn. Hold on."
            ],
            anger: [
                "Anger is a valid emotion. Breathe through it.",
                "Pause. Count to ten. Give yourself space to respond, not react.",
                "Your anger is a signal that something needs attention.",
                "Transform anger into positive action when you're ready.",
                "This feeling will pass like a storm cloud.",
                "You have the power to respond with calm strength.",
                "Anger is energy - channel it constructively.",
                "Breathe in calm, breathe out tension.",
                "You control your response, not the trigger.",
                "This frustration does not define you."
            ],
            sadness: [
                "Tears cleanse the soul. Let them flow.",
                "Your sadness honors what matters to you.",
                "This heaviness will lift. Be patient with yourself.",
                "You are not alone in your pain.",
                "Sadness carves depth for greater joy later.",
                "Be gentle with your tender heart today.",
                "This pain is creating space for new growth.",
                "You've survived sadness before. You will again.",
                "Your feelings are valid messengers.",
                "The depth of your sadness reflects your capacity for joy."
            ]
        };
        
        // DOM元素
        const encouragement = document.getElementById('encouragement');
        const loadingOverlay = document.getElementById('loading-overlay');
        const videoElement = document.getElementById('camera-feed');
        const canvasElement = document.getElementById('overlay-canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const starsContainer = document.getElementById('stars');
        const moon = document.getElementById('moon');
        
        // 创建星空背景
        function createStars() {
            starsContainer.innerHTML = '';
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${Math.random() * 3 + 1}px`;
                star.style.height = star.style.width;
                star.style.animationDuration = `${Math.random() * 5 + 2}s`;
                starsContainer.appendChild(star);
            }
        }
        
        // 创建月亮陨石坑
        function createMoonCraters() {
            for (let i = 0; i < 8; i++) {
                const crater = document.createElement('div');
                crater.className = 'moon-crater';
                crater.style.width = `${Math.random() * 20 + 5}px`;
                crater.style.height = crater.style.width;
                crater.style.top = `${Math.random() * 80 + 10}%`;
                crater.style.left = `${Math.random() * 80 + 10}%`;
                moon.appendChild(crater);
            }
        }
        
        // 初始化手部追踪
        async function initHandTracking() {
            if (handTrackingActive) return;
            
            loadingOverlay.style.display = 'flex';
            
            // 创建Hands对象
            const hands = new window.Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });
            
            // 设置选项
            hands.setOptions({
                maxNumHands: 2,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            // 结果处理
            hands.onResults((results) => {
                if (loadingOverlay.style.display !== 'none') {
                    loadingOverlay.style.display = 'none';
                    createStars();
                    createMoonCraters();
                }
                
                // 更新FPS计数
                updateFPS();
                
                // 清除画布
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                
                // 绘制星空
                drawStars();
                
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    // 检测到手部
                    for (const landmarks of results.multiHandLandmarks) {
                        const indexTip = landmarks[8]; // 食指指尖
                        let x = indexTip.x * canvasElement.width;
                        let y = indexTip.y * canvasElement.height;
                        
                        // 解决镜像问题：翻转x坐标
                        x = canvasElement.width - x;
                        
                        // 绘制手部位置光晕
                        drawHandHalo(x, y);
                        
                        // 检测是否捕捉到星星
                        checkStarCapture(x, y);
                    }
                }
                
                // 更新星星
                updateStars();
            });
            
            try {
                // 获取摄像头访问权限
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                videoElement.srcObject = stream;
                await videoElement.play();
                
                // 设置画布尺寸
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                
                // 启动摄像头处理
                const camera = new window.Camera(videoElement, {
                    onFrame: async () => {
                        try {
                            await hands.send({ image: videoElement });
                        } catch (e) {
                            console.error('Hand processing error:', e);
                        }
                    },
                    width: videoElement.videoWidth,
                    height: videoElement.videoHeight
                });
                
                camera.start();
                handTrackingActive = true;
                
            } catch (error) {
                console.error("Camera access failed:", error);
                loadingOverlay.style.display = 'none';
                
                // 创建错误信息
                const errorDiv = document.createElement('div');
                errorDiv.className = 'instructions';
                errorDiv.innerHTML = `<div style="color: #ff6b6b; font-weight: bold;">Error: ${error.message}</div>`;
                document.querySelector('.container').appendChild(errorDiv);
            }
        }
        
        // 绘制手部位置光晕
        function drawHandHalo(x, y) {
            canvasCtx.save();
            canvasCtx.beginPath();
            canvasCtx.arc(x, y, 40, 0, Math.PI * 2);
            
            const gradient = canvasCtx.createRadialGradient(x, y, 0, x, y, 40);
            gradient.addColorStop(0, 'rgba(101, 178, 230, 0.8)');
            gradient.addColorStop(1, 'rgba(101, 178, 230, 0)');
            
            canvasCtx.fillStyle = gradient;
            canvasCtx.fill();
            canvasCtx.restore();
        }
        
        // 绘制星星
        function drawStars() {
            // 随机添加新星星
            if (Math.random() < 0.05 && stars.length < 30) {
                stars.push({
                    x: Math.random() * canvasElement.width,
                    y: Math.random() * canvasElement.height * 0.8,
                    size: Math.random() * 8 + 4,
                    brightness: Math.random() * 0.5 + 0.5,
                    speed: Math.random() * 1 + 0.5,
                    captured: false
                });
            }
            
            // 绘制所有星星
            stars.forEach(star => {
                if (star.captured) return;
                
                canvasCtx.save();
                canvasCtx.beginPath();
                canvasCtx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                
                const gradient = canvasCtx.createRadialGradient(
                    star.x, star.y, 0, 
                    star.x, star.y, star.size
                );
                gradient.addColorStop(0, `rgba(255, 255, 255, ${star.brightness})`);
                gradient.addColorStop(1, `rgba(168, 216, 255, ${star.brightness * 0.3})`);
                
                canvasCtx.fillStyle = gradient;
                canvasCtx.fill();
                
                // 添加星芒效果
                for (let i = 0; i < 4; i++) {
                    canvasCtx.save();
                    canvasCtx.translate(star.x, star.y);
                    canvasCtx.rotate(i * Math.PI / 4);
                    
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(star.size * 1.5, 0);
                    canvasCtx.lineTo(star.size * 2.5, 0);
                    canvasCtx.strokeStyle = `rgba(255, 255, 255, ${star.brightness * 0.7})`;
                    canvasCtx.lineWidth = 2;
                    canvasCtx.stroke();
                    
                    canvasCtx.restore();
                }
                
                canvasCtx.restore();
            });
        }
        
        // 更新星星位置
        function updateStars() {
            stars = stars.filter(star => {
                // 被捕抓的星星向上飞走
                if (star.captured) {
                    star.y -= star.speed * 3;
                    return star.y > -50;
                }
                
                // 未被捕抓的星星缓慢移动
                star.x += (Math.random() - 0.5) * star.speed;
                star.y += (Math.random() - 0.5) * star.speed;
                
                // 确保星星在屏幕内
                star.x = Math.max(10, Math.min(canvasElement.width - 10, star.x));
                star.y = Math.max(10, Math.min(canvasElement.height - 10, star.y));
                
                return true;
            });
        }
        
        // 检测是否捕捉到星星
        function checkStarCapture(x, y) {
            stars.forEach((star, index) => {
                if (star.captured) return;
                
                const distance = Math.sqrt(Math.pow(star.x - x, 2) + Math.pow(star.y - y, 2));
                
                if (distance < 50) {
                    star.captured = true;
                    capturedStars++;
                    
                    // 显示鼓励语
                    showEncouragement('general');
                    
                    // 创建捕捉效果
                    createCaptureEffect(star.x, star.y);
                }
            });
        }
        
        // 显示鼓励语
        function showEncouragement(type) {
            const texts = encouragements[type];
            const text = texts[Math.floor(Math.random() * texts.length)];
            encouragement.textContent = text;
            encouragement.style.opacity = 1;
            
            setTimeout(() => {
                encouragement.style.opacity = 0;
            }, 3000);
        }
        
        // 创建捕捉效果
        function createCaptureEffect(x, y) {
            // 捕捉光圈效果
            const effect = document.createElement('div');
            effect.className = 'capture-effect';
            effect.style.left = `${x - 50}px`;
            effect.style.top = `${y - 50}px`;
            document.querySelector('.container').appendChild(effect);
            
            // 动画
            let size = 100;
            const grow = setInterval(() => {
                size += 10;
                effect.style.width = `${size}px`;
                effect.style.height = `${size}px`;
                effect.style.left = `${x - size/2}px`;
                effect.style.top = `${y - size/2}px`;
                effect.style.opacity = `${1 - size/200}`;
                
                if (size > 200) {
                    clearInterval(grow);
                    effect.remove();
                }
            }, 20);
        }
        
        // 重置星空
        function resetStars() {
            stars = [];
            capturedStars = 0;
            
            // 添加重置动画
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const star = document.createElement('div');
                    star.className = 'star-animation';
                    star.innerHTML = '✨';
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 100 + 100}%`;
                    star.style.fontSize = `${Math.random() * 30 + 20}px`;
                    star.style.setProperty('--tx', `${(Math.random() - 0.5) * 300}px`);
                    star.style.setProperty('--ty', `${-Math.random() * 300 - 150}px`);
                    document.body.appendChild(star);
                    
                    setTimeout(() => {
                        star.remove();
                    }, 3000);
                }, i * 100);
            }
            
            showEncouragement('general');
        }
        
        // 更新FPS计数
        function updateFPS() {
            frameCount++;
            const now = performance.now();
            const elapsed = now - lastFrameTime;
            
            if (elapsed >= 1000) {
                fps = Math.round((frameCount * 1000) / elapsed);
                frameCount = 0;
                lastFrameTime = now;
            }
        }
        
        // 许愿功能
        function makeAWish() {
            const wish = document.createElement('div');
            wish.className = 'star-animation';
            wish.innerHTML = '💫';
            wish.style.left = `${Math.random() * 100}%`;
            wish.style.top = `${Math.random() * 100 + 100}%`;
            wish.style.fontSize = '40px';
            wish.style.setProperty('--tx', `${(Math.random() - 0.5) * 200}px`);
            wish.style.setProperty('--ty', `${-Math.random() * 200 - 200}px`);
            document.body.appendChild(wish);
            
            setTimeout(() => {
                wish.remove();
            }, 3000);
            
            // 显示许愿语
            const wishes = [
                "May you find peace in this moment",
                "May your heart heal with each passing day",
                "May you find strength in your vulnerability",
                "May calm replace turmoil in your soul",
                "May you release what no longer serves you"
            ];
            
            encouragement.textContent = wishes[Math.floor(Math.random() * wishes.length)];
            encouragement.style.opacity = 1;
            
            setTimeout(() => {
                encouragement.style.opacity = 0;
            }, 4000);
        }
        
        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 添加事件监听器
            document.getElementById('start-btn').addEventListener('click', initHandTracking);
            document.getElementById('reset-btn').addEventListener('click', resetStars);
            document.getElementById('wish-btn').addEventListener('click', makeAWish);
            
            // 创建初始星星
            createStars();
            createMoonCraters();
        });
    </script>
</body>
</html>
