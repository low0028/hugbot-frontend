<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HugBot - Simplified AR Test</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    #chat-container {
      width: 100%;
      height: 40%;
      background: rgba(255, 255, 255, 0.85);
      padding: 20px;
      display: flex;
      flex-direction: column;
      z-index: 10;
    }
    
    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      margin-bottom: 15px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 12px;
    }
    
    .message {
      margin: 10px 0;
      padding: 12px 15px;
      border-radius: 18px;
      max-width: 80%;
    }
    
    .user-message {
      background: #4ECDC4;
      color: white;
      margin-left: auto;
    }
    
    .bot-message {
      background: white;
      border: 1px solid #e0e0e0;
      margin-right: auto;
    }
    
    #input-area {
      display: flex;
      gap: 10px;
    }
    
    #user-input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 25px;
    }
    
    #send-button {
      background: #FF6B6B;
      color: white;
      border: none;
      border-radius: 25px;
      padding: 0 25px;
      cursor: pointer;
    }
    
    #ar-container {
      flex: 1;
      position: relative;
      display: none;
      background: black;
    }
    
    #three-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    #camera-feed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
    }
    
    #debug-panel {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      z-index: 10000;
      border-radius: 8px;
    }
    
    .debug-btn {
      background: #4ECDC4;
      color: white;
      border: none;
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      cursor: pointer;
      display: block;
      width: 100%;
    }
  </style>
</head>
<body>
  <!-- 聊天界面 -->
  <div id="chat-container">
    <div id="chat-box">
      <div class="message bot-message">
        AR测试模式 - 请输入"sad"测试虚拟拥抱
      </div>
    </div>
    <div id="input-area">
      <input type="text" id="user-input" placeholder="输入'sad'测试..." autocomplete="off" />
      <button id="send-button">Send</button>
    </div>
  </div>
  
  <!-- AR场景容器 -->
  <div id="ar-container">
    <canvas id="three-canvas"></canvas>
    <video id="camera-feed" autoplay playsinline></video>
    <div style="position: absolute; top: 20px; left: 20px; color: white; z-index: 20;">
      <div id="status-text">状态: 等待启动</div>
      <button id="end-hug" style="background: #FF6B6B; color: white; border: none; padding: 8px; margin-top: 10px; border-radius: 4px;">结束AR</button>
    </div>
  </div>
  
  <!-- 调试面板 -->
  <div id="debug-panel">
    <button class="debug-btn" id="test-camera">测试摄像头</button>
    <button class="debug-btn" id="test-ar">测试AR场景</button>
    <button class="debug-btn" id="test-notification">测试通知</button>
  </div>

  <!-- 使用简单Three.js实现 -->
  <script>
    // 简化版AR系统
    const ARSystem = {
      scene: null,
      camera: null,
      renderer: null,
      isActive: false,
      videoElement: document.getElementById('camera-feed'),
      statusElement: document.getElementById('status-text'),
      arContainer: document.getElementById('ar-container'),
      
      // 初始化Three.js
      initThree: function() {
        this.statusElement.textContent = "状态: 初始化Three.js";
        console.log("初始化Three.js场景");
        
        // 创建场景
        this.scene = new THREE.Scene();
        
        // 创建相机
        this.camera = new THREE.PerspectiveCamera(
          75, 
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        this.camera.position.z = 5;
        
        // 创建渲染器
        const canvas = document.getElementById('three-canvas');
        this.renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        
        // 添加灯光
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        this.scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(1, 1, 3);
        this.scene.add(directionalLight);
        
        // 添加简单物体 - 使用立方体替代GLB
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
        this.cube = new THREE.Mesh(geometry, material);
        this.scene.add(this.cube);
        
        console.log("Three.js初始化完成");
        this.statusElement.textContent = "状态: Three.js已初始化";
      },
      
      // 启动摄像头
      startCamera: function() {
        this.statusElement.textContent = "状态: 请求摄像头权限";
        console.log("请求摄像头权限");
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          this.statusElement.textContent = "错误: 浏览器不支持摄像头";
          console.error("浏览器不支持摄像头API");
          return;
        }
        
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => {
            this.statusElement.textContent = "状态: 摄像头已启动";
            console.log("摄像头访问成功");
            
            // 显示视频流
            this.videoElement.srcObject = stream;
            this.videoElement.style.display = 'block';
            
            // 开始动画循环
            this.animate();
          })
          .catch(error => {
            this.statusElement.textContent = `错误: ${error.message}`;
            console.error("摄像头访问失败:", error);
          });
      },
      
      // 启动AR会话
      startARHugSession: function() {
        if (this.isActive) return;
        
        this.statusElement.textContent = "状态: 启动AR会话";
        console.log("启动AR会话");
        
        // 显示AR容器
        this.arContainer.style.display = 'block';
        this.isActive = true;
        
        // 初始化Three.js（如果尚未初始化）
        if (!this.scene) {
          this.initThree();
        }
        
        // 启动摄像头
        this.startCamera();
      },
      
      // 结束AR会话
      endARHugSession: function() {
        this.statusElement.textContent = "状态: 会话结束";
        console.log("结束AR会话");
        this.arContainer.style.display = 'none';
        this.isActive = false;
        
        // 停止视频流
        if (this.videoElement.srcObject) {
          const tracks = this.videoElement.srcObject.getTracks();
          tracks.forEach(track => track.stop());
          this.videoElement.srcObject = null;
        }
      },
      
      // 动画循环
      animate: function() {
        if (!this.isActive) return;
        
        requestAnimationFrame(() => this.animate());
        
        // 旋转立方体
        if (this.cube) {
          this.cube.rotation.x += 0.01;
          this.cube.rotation.y += 0.01;
        }
        
        // 渲染场景
        if (this.renderer && this.scene && this.camera) {
          this.renderer.render(this.scene, this.camera);
        }
      }
    };
    
    // 暴露给全局
    window.ARSystem = ARSystem;
    
    // 添加事件监听器
    document.getElementById('end-hug').addEventListener('click', () => {
      ARSystem.endARHugSession();
    });
    
    document.getElementById('test-camera').addEventListener('click', () => {
      ARSystem.startARHugSession();
    });
    
    document.getElementById('test-ar').addEventListener('click', () => {
      ARSystem.startARHugSession();
    });
    
    document.getElementById('test-notification').addEventListener('click', () => {
      alert("测试通知: 这是虚拟拥抱通知!");
    });
    
    // 初始化Three.js库
    function loadThreeJS() {
      return new Promise((resolve, reject) => {
        if (window.THREE) {
          console.log("Three.js已加载");
          resolve();
          return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
    
    // 页面加载完成后初始化
    window.addEventListener('DOMContentLoaded', async () => {
      console.log("DOM加载完成");
      
      try {
        // 加载Three.js库
        await loadThreeJS();
        console.log("Three.js库加载成功");
      } catch (error) {
        console.error("无法加载Three.js:", error);
        alert("无法加载Three.js库，请检查网络连接");
      }
      
      // 聊天系统
      const sendBtn = document.getElementById("send-button");
      const userInput = document.getElementById("user-input");
      const chatBox = document.getElementById("chat-box");
      
      sendBtn.addEventListener("click", async () => {
        const text = userInput.value.trim();
        if (!text) return;
        
        // 显示用户消息
        const userMsg = document.createElement("div");
        userMsg.className = "message user-message";
        userMsg.textContent = `You: ${text}`;
        chatBox.appendChild(userMsg);
        
        userInput.value = "";
        chatBox.scrollTop = chatBox.scrollHeight;
        
        // 检测"sad"关键词
        if (text.toLowerCase().includes("sad")) {
          // 显示虚拟拥抱消息
          const botMsg1 = document.createElement("div");
          botMsg1.className = "message bot-message";
          botMsg1.textContent = "HugBot: 检测到伤心情绪，发送虚拟拥抱中... 🧸";
          chatBox.appendChild(botMsg1);
          
          // 启动AR系统
          setTimeout(() => {
            if (window.ARSystem && typeof window.ARSystem.startARHugSession === 'function') {
              window.ARSystem.startARHugSession();
            } else {
              const errorMsg = document.createElement("div");
              errorMsg.className = "message bot-message";
              errorMsg.textContent = "HugBot: AR系统初始化失败";
              chatBox.appendChild(errorMsg);
            }
          }, 1000);
        } else {
          // 普通回复
          const botMsg = document.createElement("div");
          botMsg.className = "message bot-message";
          botMsg.textContent = "HugBot: 收到您的消息";
          chatBox.appendChild(botMsg);
        }
        
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    });
  </script>
</body>
</html>
