// æƒ…ç»ªæ£€æµ‹é…ç½®
const EMOTION_API_URL = "http://your-emotion-api-endpoint/analyze";
const SADNESS_THRESHOLD = 0.7; // ä¼¤å¿ƒæƒ…ç»ªé˜ˆå€¼

// DOMå…ƒç´ 
const chatBox = document.getElementById('chat-box');
const userInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-button');

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
  sendButton.addEventListener('click', sendMessage);
  userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });
});

// å‘é€æ¶ˆæ¯
async function sendMessage() {
  const message = userInput.value.trim();
  if (!message) return;
  
  // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
  displayMessage(message, 'user');
  userInput.value = '';
  
  // åˆ†ææƒ…ç»ª
  const emotionResult = await analyzeEmotion(message);
  
  // æ£€æµ‹ä¼¤å¿ƒæƒ…ç»ª
  if (emotionResult.stress_level > SADNESS_THRESHOLD) {
    triggerVirtualHug();
  } else {
    // ç”Ÿæˆæ™®é€šå›å¤
    const reply = generateReply(emotionResult);
    displayMessage(reply, 'bot');
  }
}

// æ˜¾ç¤ºæ¶ˆæ¯
function displayMessage(message, sender) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}-message`;
  messageDiv.textContent = message;
  
  chatBox.appendChild(messageDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// åˆ†ææƒ…ç»ª
async function analyzeEmotion(text) {
  try {
    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨API
    // æ¨¡æ‹Ÿå®ç°
    return new Promise(resolve => {
      setTimeout(() => {
        // éšæœºç”Ÿæˆå‹åŠ›å€¼ç”¨äºæµ‹è¯•
        const stressLevel = Math.random();
        console.log(`[æƒ…ç»ªåˆ†æ] "${text}" - å‹åŠ›å€¼: ${stressLevel.toFixed(2)}`);
        
        resolve({
          stress_level: stressLevel,
          primary_emotion: stressLevel > 0.7 ? 'sadness' : 'neutral'
        });
      }, 800);
    });
  } catch (error) {
    console.error('æƒ…ç»ªåˆ†æå¤±è´¥:', error);
    return { stress_level: 0.5, primary_emotion: 'neutral' };
  }
}

// è§¦å‘è™šæ‹Ÿæ‹¥æŠ±
function triggerVirtualHug() {
  // æ˜¾ç¤ºé€šçŸ¥
  if (window.ARSystem && window.ARSystem.startARHugSession) {
    // åœ¨èŠå¤©æ¡†ä¸­æ˜¾ç¤ºæ¶ˆæ¯
    displayMessage("I sense you're feeling down. Sending a virtual hug your way... ğŸ§¸", 'bot');
    
    // å¯åŠ¨ARæ‹¥æŠ±ä¼šè¯
    setTimeout(() => {
      window.ARSystem.startARHugSession();
    }, 1500);
  } else {
    console.error('ARç³»ç»Ÿæœªåˆå§‹åŒ–');
    displayMessage("I'd give you a hug if I could! ğŸ«‚", 'bot');
  }
}

// ç”Ÿæˆå›å¤
function generateReply(emotionResult) {
  const replies = [
    "Thanks for sharing!",
    "I'm here for you.",
    "Tell me more about that.",
    "That sounds interesting!",
    "How did that make you feel?",
    "I appreciate you opening up."
  ];
  
  return replies[Math.floor(Math.random() * replies.length)];
}
