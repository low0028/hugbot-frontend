<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR虚拟拥抱助手</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      color: white;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      z-index: 100;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem;
    }
    
    .logo i {
      color: #ffcc70;
    }
    
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(0, 0, 0, 0.3);
      padding: 5px 15px;
      border-radius: 20px;
    }
    
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #4cff88;
      box-shadow: 0 0 8px #4cff88;
    }
    
    #chat-container {
      width: 100%;
      height: 40%;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      display: flex;
      flex-direction: column;
      z-index: 10;
      backdrop-filter: blur(5px);
    }
    
    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      margin-bottom: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .message {
      padding: 12px 18px;
      border-radius: 18px;
      max-width: 85%;
      position: relative;
      animation: fadeIn 0.3s ease;
    }
    
    .user-message {
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 5px;
    }
    
    .bot-message {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      margin-right: auto;
      border-bottom-left-radius: 5px;
    }
    
    .bot-icon {
      position: absolute;
      left: -32px;
      top: 0;
      width: 28px;
      height: 28px;
      background: #ff6b6b;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #input-area {
      display: flex;
      gap: 10px;
    }
    
    #user-input {
      flex: 1;
      padding: 14px 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 30px;
      background: rgba(0, 0, 0, 0.3);
      color: white;
      font-size: 1rem;
    }
    
    #user-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    #send-button {
      background: linear-gradient(135deg, #ff7e5f, #feb47b);
      color: white;
      border: none;
      border-radius: 30px;
      padding: 0 30px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s;
    }
    
    #send-button:hover {
      transform: scale(1.05);
    }
    
    #ar-container {
      flex: 1;
      position: relative;
      display: none;
      background: black;
    }
    
    #three-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 5;
    }
    
    #camera-feed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      transform: scaleX(-1);
      z-index: 1;
    }
    
    #ar-controls {
      position: absolute;
      top: 20px;
      left: 20px;
      color: white;
      z-index: 20;
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    #status-text {
      font-size: 1.1rem;
      margin-bottom: 10px;
    }
    
    #hug-timer {
      font-size: 1.3rem;
      font-weight: bold;
      color: #ffcc70;
      margin: 10px 0;
    }
    
    .control-btn {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    
    .control-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    
    #hand-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      pointer-events: none;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #3a1c71, #d76d77);
      color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 15px;
      transform: translateX(120%);
      transition: transform 0.4s ease;
    }
    
    .notification.active {
      transform: translateX(0);
    }
    
    .notification-icon {
      font-size: 1.8rem;
      color: #ffcc70;
    }
    
    .notification-content h3 {
      margin-bottom: 5px;
      font-size: 1.2rem;
    }
    
    .model-selector {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .model-btn {
      padding: 8px 15px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .model-btn.active {
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      box-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes float {
      0% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0); }
    }
  </style>
</head>
<body>
  <!-- 头部 -->
  <header>
    <div class="logo">
      <i class="fas fa-robot"></i>
      <span>AR虚拟拥抱助手</span>
    </div>
    <div class="status">
      <div class="status-indicator"></div>
      <span>在线</span>
    </div>
  </header>
  
  <!-- 聊天界面 -->
  <div id="chat-container">
    <div id="chat-box">
      <div class="message bot-message">
        <div class="bot-icon"><i class="fas fa-robot"></i></div>
        您好！我是您的情绪陪伴助手。当您输入包含"sad"的信息时，我会为您提供虚拟拥抱支持。
      </div>
    </div>
    <div id="input-area">
      <input type="text" id="user-input" placeholder="告诉我您的心情..." autocomplete="off" />
      <button id="send-button">发送</button>
    </div>
  </div>
  
  <!-- AR场景容器 -->
  <div id="ar-container">
    <canvas id="three-canvas"></canvas>
    <video id="camera-feed" autoplay playsinline></video>
    <canvas id="hand-canvas"></canvas>
    
    <div id="ar-controls">
      <div id="status-text">状态: 等待启动</div>
      <div id="hug-timer">拥抱时间: 30秒</div>
      <div class="model-selector">
        <button class="model-btn active" data-model="fox">小狐狸</button>
        <button class="model-btn" data-model="panda">熊猫</button>
        <button class="model-btn" data-model="fairy">小精灵</button>
      </div>
      <button class="control-btn" id="end-hug">
        <i class="fas fa-times-circle"></i> 结束AR
      </button>
    </div>
  </div>
  
  <!-- 通知 -->
  <div class="notification" id="notification">
    <div class="notification-icon">
      <i class="fas fa-hands-helping"></i>
    </div>
    <div class="notification-content">
      <h3>虚拟拥抱已启动</h3>
      <p>伸出手掌接收小狐狸的拥抱吧！</p>
    </div>
  </div>

  <script>
    // 状态管理
    const AppState = {
      currentModel: 'fox',
      hugActive: false,
      hugTimer: null,
      hugDuration: 30,
      modelObjects: {},
      handsDetected: false
    };

    // AR系统
    const ARSystem = {
      scene: null,
      camera: null,
      renderer: null,
      videoElement: document.getElementById('camera-feed'),
      statusElement: document.getElementById('status-text'),
      timerElement: document.getElementById('hug-timer'),
      arContainer: document.getElementById('ar-container'),
      handCanvas: document.getElementById('hand-canvas'),
      handCtx: null,
      
      // 初始化Three.js
      initThree: function() {
        this.updateStatus("初始化3D场景...");
        
        // 创建场景
        this.scene = new THREE.Scene();
        this.scene.background = null;
        
        // 创建相机
        this.camera = new THREE.PerspectiveCamera(
          75, 
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        this.camera.position.set(0, 0.5, 5);
        
        // 创建渲染器
        const canvas = document.getElementById('three-canvas');
        this.renderer = new THREE.WebGLRenderer({ 
          canvas, 
          antialias: true,
          alpha: true
        });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.setPixelRatio(window.devicePixelRatio);
        
        // 添加灯光
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        this.scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(1, 1, 3);
        this.scene.add(directionalLight);
        
        // 初始化手部画布
        this.handCtx = this.handCanvas.getContext('2d');
        this.handCanvas.width = window.innerWidth;
        this.handCanvas.height = window.innerHeight;
        
        this.updateStatus("3D场景已初始化");
      },
      
      // 加载模型
      loadModel: function(modelType) {
        this.updateStatus(`加载${modelType}模型...`);
        
        // 如果模型已存在，从场景中移除
        if (AppState.modelObjects[modelType]) {
          this.scene.remove(AppState.modelObjects[modelType]);
        }
        
        // 模型路径映射
        const modelPaths = {
          fox: "https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@2.0.0/2.0/Fox/glTF-Binary/Fox.glb",
          panda: "https://cdn.jsdelivr.net/gh/mrdoob/three.js@r132/examples/models/gltf/LittlestTokyo.glb",
          fairy: "https://cdn.jsdelivr.net/gh/mrdoob/three.js@r132/examples/models/gltf/Flamingo.glb"
        };
        
        const loader = new THREE.GLTFLoader();
        loader.load(modelPaths[modelType], (gltf) => {
          const model = gltf.scene;
          model.scale.set(0.02, 0.02, 0.02);
          model.position.set(0, -1, -2);
          
          // 添加动画
          this.animateModel(model);
          
          // 保存模型引用
          AppState.modelObjects[modelType] = model;
          this.scene.add(model);
          
          this.updateStatus(`${modelType}模型加载完成`);
        }, undefined, (error) => {
          this.updateStatus(`模型加载错误: ${error.message}`);
          console.error(error);
        });
      },
      
      // 模型动画
      animateModel: function(model) {
        // 初始旋转值
        let rotationY = 0;
        
        // 动画函数
        const animate = () => {
          if (!AppState.hugActive) return;
          
          // 更新模型旋转
          rotationY += 0.01;
          model.rotation.y = rotationY;
          
          // 添加浮动效果
          const time = Date.now() * 0.001;
          model.position.y = -1 + Math.sin(time) * 0.1;
          
          requestAnimationFrame(animate);
        };
        
        animate();
      },
      
      // 启动摄像头
      startCamera: function() {
        this.updateStatus("请求摄像头权限...");
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          this.updateStatus("错误: 浏览器不支持摄像头");
          return;
        }
        
        navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: "user",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        })
        .then(stream => {
          this.updateStatus("摄像头已启动");
          
          // 显示视频流
          this.videoElement.srcObject = stream;
          this.videoElement.style.display = 'block';
          
          // 初始化手部追踪
          this.initHandTracking();
          
          // 开始动画循环
          this.animate();
        })
        .catch(error => {
          this.updateStatus(`摄像头错误: ${error.message}`);
        });
      },
      
      // 初始化手部追踪
      initHandTracking: function() {
        this.updateStatus("初始化手部追踪...");
        
        const hands = new Hands({
          locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
          }
        });
        
        hands.setOptions({
          maxNumHands: 1,
          modelComplexity: 1,
          minDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5
        });
        
        hands.onResults((results) => {
          this.processHandResults(results);
        });
        
        // 启动摄像头处理
        const camera = new Camera(this.videoElement, {
          onFrame: async () => {
            await hands.send({image: this.videoElement});
          },
          width: 1280,
          height: 720
        });
        
        camera.start();
      },
      
      // 处理手部结果
      processHandResults: function(results) {
        this.handCtx.clearRect(0, 0, this.handCanvas.width, this.handCanvas.height);
        
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
          // 绘制手部关键点
          drawConnectors(this.handCtx, results.multiHandLandmarks[0], HAND_CONNECTIONS, {
            color: '#00FF00',
            lineWidth: 4
          });
          
          drawLandmarks(this.handCtx, results.multiHandLandmarks[0], {
            color: '#FF0000',
            lineWidth: 2,
            radius: 4
          });
          
          // 检查是否首次检测到手
          if (!AppState.handsDetected) {
            AppState.handsDetected = true;
            this.showNotification("手部已检测到", "伸出手掌接收虚拟拥抱吧！");
          }
        } else {
          AppState.handsDetected = false;
        }
      },
      
      // 启动AR会话
      startARHugSession: function() {
        if (AppState.hugActive) return;
        
        this.updateStatus("启动虚拟拥抱...");
        this.arContainer.style.display = 'block';
        AppState.hugActive = true;
        
        // 初始化Three.js
        if (!this.scene) {
          this.initThree();
        }
        
        // 加载模型
        this.loadModel(AppState.currentModel);
        
        // 启动摄像头
        this.startCamera();
        
        // 启动计时器
        this.startHugTimer();
        
        // 显示通知
        this.showNotification("虚拟拥抱已启动", "伸出手掌接收小狐狸的拥抱吧！");
      },
      
      // 启动拥抱计时器
      startHugTimer: function() {
        let seconds = AppState.hugDuration;
        this.timerElement.textContent = `拥抱时间: ${seconds}秒`;
        
        AppState.hugTimer = setInterval(() => {
          seconds--;
          this.timerElement.textContent = `拥抱时间: ${seconds}秒`;
          
          if (seconds <= 0) {
            this.endARHugSession();
          }
        }, 1000);
      },
      
      // 结束AR会话
      endARHugSession: function() {
        this.updateStatus("会话结束");
        this.arContainer.style.display = 'none';
        AppState.hugActive = false;
        AppState.handsDetected = false;
        
        // 清除计时器
        if (AppState.hugTimer) {
          clearInterval(AppState.hugTimer);
          AppState.hugTimer = null;
        }
        
        // 停止视频流
        if (this.videoElement.srcObject) {
          const tracks = this.videoElement.srcObject.getTracks();
          tracks.forEach(track => track.stop());
          this.videoElement.srcObject = null;
        }
        
        // 添加聊天消息
        const chatBox = document.getElementById('chat-box');
        const botMsg = document.createElement("div");
        botMsg.className = "message bot-message";
        botMsg.innerHTML = `<div class="bot-icon"><i class="fas fa-robot"></i></div>虚拟拥抱已完成！希望您感觉好些了。`;
        chatBox.appendChild(botMsg);
        chatBox.scrollTop = chatBox.scrollHeight;
        
        // 显示通知
        this.showNotification("拥抱完成", "您的压力已转化为一朵情绪花朵！");
      },
      
      // 显示通知
      showNotification: function(title, message) {
        const notification = document.getElementById('notification');
        const content = notification.querySelector('.notification-content');
        
        content.querySelector('h3').textContent = title;
        content.querySelector('p').textContent = message;
        
        notification.classList.add('active');
        
        // 3秒后隐藏
        setTimeout(() => {
          notification.classList.remove('active');
        }, 3000);
      },
      
      // 更新状态
      updateStatus: function(text) {
        this.statusElement.textContent = `状态: ${text}`;
      },
      
      // 动画循环
      animate: function() {
        if (!AppState.hugActive) return;
        
        requestAnimationFrame(() => this.animate());
        
        // 渲染场景
        if (this.renderer && this.scene && this.camera) {
          this.renderer.render(this.scene, this.camera);
        }
      }
    };
    
    // 手部连接定义
    const HAND_CONNECTIONS = [
      [0, 1], [1, 2], [2, 3], [3, 4],
      [0, 5], [5, 6], [6, 7], [7, 8],
      [0, 9], [9, 10], [10, 11], [11, 12],
      [0, 13], [13, 14], [14, 15], [15, 16],
      [0, 17], [17, 18], [18, 19], [19, 20]
    ];
    
    // 初始化页面
    window.addEventListener('DOMContentLoaded', () => {
      // 聊天系统
      const sendBtn = document.getElementById("send-button");
      const userInput = document.getElementById("user-input");
      const chatBox = document.getElementById("chat-box");
      
      sendBtn.addEventListener("click", () => {
        const text = userInput.value.trim();
        if (!text) return;
        
        // 显示用户消息
        const userMsg = document.createElement("div");
        userMsg.className = "message user-message";
        userMsg.textContent = text;
        chatBox.appendChild(userMsg);
        
        userInput.value = "";
        chatBox.scrollTop = chatBox.scrollHeight;
        
        // 检测"sad"关键词
        if (text.toLowerCase().includes("sad")) {
          // 显示虚拟拥抱消息
          const botMsg = document.createElement("div");
          botMsg.className = "message bot-message";
          botMsg.innerHTML = `<div class="bot-icon"><i class="fas fa-robot"></i></div>检测到伤心情绪，正在启动虚拟拥抱...`;
          chatBox.appendChild(botMsg);
          
          // 启动AR系统
          setTimeout(() => {
            ARSystem.startARHugSession();
          }, 1000);
        } else {
          // 普通回复
          const botMsg = document.createElement("div");
          botMsg.className = "message bot-message";
          botMsg.innerHTML = `<div class="bot-icon"><i class="fas fa-robot"></i></div>已收到您的消息，如果您感到压力，请告诉我。`;
          chatBox.appendChild(botMsg);
        }
        
        chatBox.scrollTop = chatBox.scrollHeight;
      });
      
      // 模型选择按钮
      document.querySelectorAll('.model-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          AppState.currentModel = btn.dataset.model;
          
          if (AppState.hugActive) {
            ARSystem.loadModel(AppState.currentModel);
          }
        });
      });
      
      // 结束AR按钮
      document.getElementById('end-hug').addEventListener('click', () => {
        ARSystem.endARHugSession();
      });
      
      // 允许回车键发送
      userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendBtn.click();
        }
      });
    });
  </script>
</body>
</html>
