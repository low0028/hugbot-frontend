// 情绪检测配置
const EMOTION_API_URL = "http://your-emotion-api-endpoint/analyze";
const SADNESS_THRESHOLD = 0.7; // 伤心情绪阈值

// DOM元素
const chatBox = document.getElementById('chat-box');
const userInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-button');

// 初始化
document.addEventListener('DOMContentLoaded', () => {
  sendButton.addEventListener('click', sendMessage);
  userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });
});

// 发送消息
async function sendMessage() {
  const message = userInput.value.trim();
  if (!message) return;
  
  // 显示用户消息
  displayMessage(message, 'user');
  userInput.value = '';
  
  // 分析情绪
  const emotionResult = await analyzeEmotion(message);
  
  // 检测伤心情绪
  if (emotionResult.stress_level > SADNESS_THRESHOLD) {
    triggerVirtualHug();
  } else {
    // 生成普通回复
    const reply = generateReply(emotionResult);
    displayMessage(reply, 'bot');
  }
}

// 显示消息
function displayMessage(message, sender) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}-message`;
  messageDiv.textContent = message;
  
  chatBox.appendChild(messageDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// 分析情绪
async function analyzeEmotion(text) {
  try {
    // 在实际应用中，这里会调用API
    // 模拟实现
    return new Promise(resolve => {
      setTimeout(() => {
        // 随机生成压力值用于测试
        const stressLevel = Math.random();
        console.log(`[情绪分析] "${text}" - 压力值: ${stressLevel.toFixed(2)}`);
        
        resolve({
          stress_level: stressLevel,
          primary_emotion: stressLevel > 0.7 ? 'sadness' : 'neutral'
        });
      }, 800);
    });
  } catch (error) {
    console.error('情绪分析失败:', error);
    return { stress_level: 0.5, primary_emotion: 'neutral' };
  }
}

// 触发虚拟拥抱
function triggerVirtualHug() {
  // 显示通知
  if (window.ARSystem && window.ARSystem.startARHugSession) {
    // 在聊天框中显示消息
    displayMessage("I sense you're feeling down. Sending a virtual hug your way... 🧸", 'bot');
    
    // 启动AR拥抱会话
    setTimeout(() => {
      window.ARSystem.startARHugSession();
    }, 1500);
  } else {
    console.error('AR系统未初始化');
    displayMessage("I'd give you a hug if I could! 🫂", 'bot');
  }
}

// 生成回复
function generateReply(emotionResult) {
  const replies = [
    "Thanks for sharing!",
    "I'm here for you.",
    "Tell me more about that.",
    "That sounds interesting!",
    "How did that make you feel?",
    "I appreciate you opening up."
  ];
  
  return replies[Math.floor(Math.random() * replies.length)];
}
