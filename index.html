<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HugBot - Simplified AR Test</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    #chat-container {
      width: 100%;
      height: 40%;
      background: rgba(255, 255, 255, 0.85);
      padding: 20px;
      display: flex;
      flex-direction: column;
      z-index: 10;
    }
    
    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      margin-bottom: 15px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 12px;
    }
    
    .message {
      margin: 10px 0;
      padding: 12px 15px;
      border-radius: 18px;
      max-width: 80%;
    }
    
    .user-message {
      background: #4ECDC4;
      color: white;
      margin-left: auto;
    }
    
    .bot-message {
      background: white;
      border: 1px solid #e0e0e0;
      margin-right: auto;
    }
    
    #input-area {
      display: flex;
      gap: 10px;
    }
    
    #user-input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 25px;
    }
    
    #send-button {
      background: #FF6B6B;
      color: white;
      border: none;
      border-radius: 25px;
      padding: 0 25px;
      cursor: pointer;
    }
    
    #ar-container {
      flex: 1;
      position: relative;
      display: none;
      background: black;
    }
    
    #three-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    #camera-feed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
    }
    
    #debug-panel {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      z-index: 10000;
      border-radius: 8px;
    }
    
    .debug-btn {
      background: #4ECDC4;
      color: white;
      border: none;
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      cursor: pointer;
      display: block;
      width: 100%;
    }
  </style>
</head>
<body>
  <!-- èŠå¤©ç•Œé¢ -->
  <div id="chat-container">
    <div id="chat-box">
      <div class="message bot-message">
        ARæµ‹è¯•æ¨¡å¼ - è¯·è¾“å…¥"sad"æµ‹è¯•è™šæ‹Ÿæ‹¥æŠ±
      </div>
    </div>
    <div id="input-area">
      <input type="text" id="user-input" placeholder="è¾“å…¥'sad'æµ‹è¯•..." autocomplete="off" />
      <button id="send-button">Send</button>
    </div>
  </div>
  
  <!-- ARåœºæ™¯å®¹å™¨ -->
  <div id="ar-container">
    <canvas id="three-canvas"></canvas>
    <video id="camera-feed" autoplay playsinline></video>
    <div style="position: absolute; top: 20px; left: 20px; color: white; z-index: 20;">
      <div id="status-text">çŠ¶æ€: ç­‰å¾…å¯åŠ¨</div>
      <button id="end-hug" style="background: #FF6B6B; color: white; border: none; padding: 8px; margin-top: 10px; border-radius: 4px;">ç»“æŸAR</button>
    </div>
  </div>
  
  <!-- è°ƒè¯•é¢æ¿ -->
  <div id="debug-panel">
    <button class="debug-btn" id="test-camera">æµ‹è¯•æ‘„åƒå¤´</button>
    <button class="debug-btn" id="test-ar">æµ‹è¯•ARåœºæ™¯</button>
    <button class="debug-btn" id="test-notification">æµ‹è¯•é€šçŸ¥</button>
  </div>

  <!-- ä½¿ç”¨ç®€å•Three.jså®ç° -->
  <script>
    // ç®€åŒ–ç‰ˆARç³»ç»Ÿ
    const ARSystem = {
      scene: null,
      camera: null,
      renderer: null,
      isActive: false,
      videoElement: document.getElementById('camera-feed'),
      statusElement: document.getElementById('status-text'),
      arContainer: document.getElementById('ar-container'),
      
      // åˆå§‹åŒ–Three.js
      initThree: function() {
        this.statusElement.textContent = "çŠ¶æ€: åˆå§‹åŒ–Three.js";
        console.log("åˆå§‹åŒ–Three.jsåœºæ™¯");
        
        // åˆ›å»ºåœºæ™¯
        this.scene = new THREE.Scene();
        
        // åˆ›å»ºç›¸æœº
        this.camera = new THREE.PerspectiveCamera(
          75, 
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        this.camera.position.z = 5;
        
        // åˆ›å»ºæ¸²æŸ“å™¨
        const canvas = document.getElementById('three-canvas');
        this.renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        
        // æ·»åŠ ç¯å…‰
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        this.scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(1, 1, 3);
        this.scene.add(directionalLight);
        
        // æ·»åŠ ç®€å•ç‰©ä½“ - ä½¿ç”¨ç«‹æ–¹ä½“æ›¿ä»£GLB
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
        this.cube = new THREE.Mesh(geometry, material);
        this.scene.add(this.cube);
        
        console.log("Three.jsåˆå§‹åŒ–å®Œæˆ");
        this.statusElement.textContent = "çŠ¶æ€: Three.jså·²åˆå§‹åŒ–";
      },
      
      // å¯åŠ¨æ‘„åƒå¤´
      startCamera: function() {
        this.statusElement.textContent = "çŠ¶æ€: è¯·æ±‚æ‘„åƒå¤´æƒé™";
        console.log("è¯·æ±‚æ‘„åƒå¤´æƒé™");
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          this.statusElement.textContent = "é”™è¯¯: æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´";
          console.error("æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´API");
          return;
        }
        
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => {
            this.statusElement.textContent = "çŠ¶æ€: æ‘„åƒå¤´å·²å¯åŠ¨";
            console.log("æ‘„åƒå¤´è®¿é—®æˆåŠŸ");
            
            // æ˜¾ç¤ºè§†é¢‘æµ
            this.videoElement.srcObject = stream;
            this.videoElement.style.display = 'block';
            
            // å¼€å§‹åŠ¨ç”»å¾ªç¯
            this.animate();
          })
          .catch(error => {
            this.statusElement.textContent = `é”™è¯¯: ${error.message}`;
            console.error("æ‘„åƒå¤´è®¿é—®å¤±è´¥:", error);
          });
      },
      
      // å¯åŠ¨ARä¼šè¯
      startARHugSession: function() {
        if (this.isActive) return;
        
        this.statusElement.textContent = "çŠ¶æ€: å¯åŠ¨ARä¼šè¯";
        console.log("å¯åŠ¨ARä¼šè¯");
        
        // æ˜¾ç¤ºARå®¹å™¨
        this.arContainer.style.display = 'block';
        this.isActive = true;
        
        // åˆå§‹åŒ–Three.jsï¼ˆå¦‚æœå°šæœªåˆå§‹åŒ–ï¼‰
        if (!this.scene) {
          this.initThree();
        }
        
        // å¯åŠ¨æ‘„åƒå¤´
        this.startCamera();
      },
      
      // ç»“æŸARä¼šè¯
      endARHugSession: function() {
        this.statusElement.textContent = "çŠ¶æ€: ä¼šè¯ç»“æŸ";
        console.log("ç»“æŸARä¼šè¯");
        this.arContainer.style.display = 'none';
        this.isActive = false;
        
        // åœæ­¢è§†é¢‘æµ
        if (this.videoElement.srcObject) {
          const tracks = this.videoElement.srcObject.getTracks();
          tracks.forEach(track => track.stop());
          this.videoElement.srcObject = null;
        }
      },
      
      // åŠ¨ç”»å¾ªç¯
      animate: function() {
        if (!this.isActive) return;
        
        requestAnimationFrame(() => this.animate());
        
        // æ—‹è½¬ç«‹æ–¹ä½“
        if (this.cube) {
          this.cube.rotation.x += 0.01;
          this.cube.rotation.y += 0.01;
        }
        
        // æ¸²æŸ“åœºæ™¯
        if (this.renderer && this.scene && this.camera) {
          this.renderer.render(this.scene, this.camera);
        }
      }
    };
    
    // æš´éœ²ç»™å…¨å±€
    window.ARSystem = ARSystem;
    
    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('end-hug').addEventListener('click', () => {
      ARSystem.endARHugSession();
    });
    
    document.getElementById('test-camera').addEventListener('click', () => {
      ARSystem.startARHugSession();
    });
    
    document.getElementById('test-ar').addEventListener('click', () => {
      ARSystem.startARHugSession();
    });
    
    document.getElementById('test-notification').addEventListener('click', () => {
      alert("æµ‹è¯•é€šçŸ¥: è¿™æ˜¯è™šæ‹Ÿæ‹¥æŠ±é€šçŸ¥!");
    });
    
    // åˆå§‹åŒ–Three.jsåº“
    function loadThreeJS() {
      return new Promise((resolve, reject) => {
        if (window.THREE) {
          console.log("Three.jså·²åŠ è½½");
          resolve();
          return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', async () => {
      console.log("DOMåŠ è½½å®Œæˆ");
      
      try {
        // åŠ è½½Three.jsåº“
        await loadThreeJS();
        console.log("Three.jsåº“åŠ è½½æˆåŠŸ");
      } catch (error) {
        console.error("æ— æ³•åŠ è½½Three.js:", error);
        alert("æ— æ³•åŠ è½½Three.jsåº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");
      }
      
      // èŠå¤©ç³»ç»Ÿ
      const sendBtn = document.getElementById("send-button");
      const userInput = document.getElementById("user-input");
      const chatBox = document.getElementById("chat-box");
      
      sendBtn.addEventListener("click", async () => {
        const text = userInput.value.trim();
        if (!text) return;
        
        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        const userMsg = document.createElement("div");
        userMsg.className = "message user-message";
        userMsg.textContent = `You: ${text}`;
        chatBox.appendChild(userMsg);
        
        userInput.value = "";
        chatBox.scrollTop = chatBox.scrollHeight;
        
        // æ£€æµ‹"sad"å…³é”®è¯
        if (text.toLowerCase().includes("sad")) {
          // æ˜¾ç¤ºè™šæ‹Ÿæ‹¥æŠ±æ¶ˆæ¯
          const botMsg1 = document.createElement("div");
          botMsg1.className = "message bot-message";
          botMsg1.textContent = "HugBot: æ£€æµ‹åˆ°ä¼¤å¿ƒæƒ…ç»ªï¼Œå‘é€è™šæ‹Ÿæ‹¥æŠ±ä¸­... ğŸ§¸";
          chatBox.appendChild(botMsg1);
          
          // å¯åŠ¨ARç³»ç»Ÿ
          setTimeout(() => {
            if (window.ARSystem && typeof window.ARSystem.startARHugSession === 'function') {
              window.ARSystem.startARHugSession();
            } else {
              const errorMsg = document.createElement("div");
              errorMsg.className = "message bot-message";
              errorMsg.textContent = "HugBot: ARç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥";
              chatBox.appendChild(errorMsg);
            }
          }, 1000);
        } else {
          // æ™®é€šå›å¤
          const botMsg = document.createElement("div");
          botMsg.className = "message bot-message";
          botMsg.textContent = "HugBot: æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯";
          chatBox.appendChild(botMsg);
        }
        
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    });
  </script>
</body>
</html>
