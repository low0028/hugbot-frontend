<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HugBot - Advanced AR Companion</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
      color: white;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: rgba(0, 0, 0, 0.7);
      padding: 15px 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 100;
    }
    
    .header h1 {
      font-size: 1.8rem;
      margin-bottom: 5px;
      color: #FF6B6B;
    }
    
    .header p {
      opacity: 0.8;
    }
    
    #chat-container {
      width: 100%;
      height: 35%;
      background: rgba(30, 30, 50, 0.8);
      padding: 20px;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(5px);
      border-top: 2px solid #4ECDC4;
    }
    
    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      margin-bottom: 15px;
      background: rgba(20, 20, 40, 0.6);
      border-radius: 12px;
      border: 1px solid rgba(100, 200, 255, 0.3);
    }
    
    .message {
      margin: 12px 0;
      padding: 12px 18px;
      border-radius: 18px;
      max-width: 85%;
      animation: fadeIn 0.4s ease;
      line-height: 1.5;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .user-message {
      background: linear-gradient(135deg, #4ECDC4, #2a8f82);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 5px;
    }
    
    .bot-message {
      background: rgba(40, 40, 80, 0.9);
      border: 1px solid rgba(100, 200, 255, 0.4);
      margin-right: auto;
      border-bottom-left-radius: 5px;
    }
    
    #input-area {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    #user-input {
      flex: 1;
      padding: 14px 18px;
      border: none;
      border-radius: 30px;
      background: rgba(50, 50, 80, 0.8);
      color: white;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    #user-input:focus {
      outline: none;
      box-shadow: 0 0 0 2px #FF6B6B;
    }
    
    #user-input::placeholder {
      color: rgba(200, 200, 255, 0.6);
    }
    
    #send-button {
      background: linear-gradient(135deg, #FF6B6B, #ff5252);
      color: white;
      border: none;
      border-radius: 30px;
      padding: 14px 28px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
      transition: all 0.3s ease;
    }
    
    #send-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(255, 107, 107, 0.4);
    }
    
    #send-button:active {
      transform: translateY(1px);
    }
    
    #ar-container {
      flex: 1;
      position: relative;
      display: none;
      background: linear-gradient(45deg, #0f2027, #203a43, #2c5364);
      overflow: hidden;
    }
    
    #three-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    
    #camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      opacity: 0.2;
    }
    
    .ar-controls {
      position: absolute;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 20;
    }
    
    .ar-btn {
      background: rgba(40, 40, 80, 0.85);
      color: white;
      border: 2px solid #4ECDC4;
      padding: 12px 25px;
      border-radius: 30px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      transition: all 0.3s;
      z-index: 30;
    }
    
    .ar-btn:hover {
      background: rgba(60, 60, 100, 0.9);
      transform: translateY(-3px);
    }
    
    #end-hug {
      background: linear-gradient(135deg, #FF6B6B, #e05555);
      border-color: #ff5252;
    }
    
    .status-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 12px 20px;
      border-radius: 30px;
      font-size: 14px;
      z-index: 20;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid rgba(100, 200, 255, 0.3);
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #FF6B6B, #ff5252);
      color: white;
      padding: 18px 25px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 15px;
      transform: translateX(150%);
      transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification-icon {
      font-size: 28px;
    }
    
    .debug-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(20, 20, 40, 0.9);
      color: white;
      padding: 15px;
      z-index: 10000;
      border-radius: 12px;
      border: 1px solid rgba(100, 200, 255, 0.3);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
      max-width: 320px;
    }
    
    .debug-title {
      margin-bottom: 15px;
      color: #FF6B6B;
      text-align: center;
    }
    
    .debug-btn {
      background: linear-gradient(135deg, #4ECDC4, #3bb5ac);
      color: white;
      border: none;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      cursor: pointer;
      display: block;
      width: 100%;
      font-weight: 500;
      box-shadow: 0 4px 10px rgba(78, 205, 196, 0.3);
      transition: all 0.3s;
    }
    
    .debug-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(78, 205, 196, 0.4);
    }
    
    .hug-animation {
      position: fixed;
      bottom: 100px;
      right: 30px;
      font-size: 60px;
      z-index: 500;
      opacity: 0;
      transform: scale(0.5);
      animation: hugFloat 4s ease-out forwards;
    }
    
    @keyframes hugFloat {
      0% { opacity: 0; transform: translateY(0) scale(0.5); }
      20% { opacity: 1; transform: translateY(-20px) scale(1); }
      80% { opacity: 1; transform: translateY(-100px) scale(1); }
      100% { opacity: 0; transform: translateY(-150px) scale(0.8); }
    }
    
    .instructions {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 15px 25px;
      border-radius: 30px;
      text-align: center;
      z-index: 25;
      max-width: 80%;
      border: 1px solid rgba(100, 200, 255, 0.4);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>HugBot - Emotional Companion</h1>
    <p>Your AI friend that understands and cares</p>
  </div>
  
  <!-- ËÅäÂ§©ÁïåÈù¢ -->
  <div id="chat-container">
    <div id="chat-box">
      <div class="message bot-message">
        Hello there! I'm HugBot, your emotional companion. üòä<br>
        Share your feelings with me - I'm here to listen and support you.<br>
        Try saying "I feel sad" to experience a virtual hug!
      </div>
    </div>
    <div id="input-area">
      <input type="text" id="user-input" placeholder="How are you feeling today?" autocomplete="off" />
      <button id="send-button">Send</button>
    </div>
  </div>
  
  <!-- ARÂú∫ÊôØÂÆπÂô® -->
  <div id="ar-container">
    <canvas id="three-canvas"></canvas>
    <div class="status-panel">
      <div id="status-text">ü¶ä AR System: Ready</div>
    </div>
    <div class="instructions">
      üëã Show your hand to interact with the virtual companion
    </div>
    <div class="ar-controls">
      <button class="ar-btn" id="end-hug">End Hug Session</button>
    </div>
  </div>
  
  <!-- ÈÄöÁü• -->
  <div class="notification" id="notification">
    <span class="notification-icon">üß∏</span>
    <span>Sending a virtual hug your way...</span>
  </div>
  
  <!-- Ë∞ÉËØïÈù¢Êùø -->
  <div class="debug-panel">
    <h3 class="debug-title">AR System Debugger</h3>
    <button class="debug-btn" id="test-camera">Test Camera</button>
    <button class="debug-btn" id="test-ar">Test AR Session</button>
    <button class="debug-btn" id="test-notification">Test Notification</button>
    <button class="debug-btn" id="test-model">Test Fox Model</button>
  </div>

  <!-- Âä†ËΩΩThree.jsÂ∫ì -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.min.js"></script>
  
  <!-- Âä†ËΩΩMediaPipeÂ∫ì -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  
  <script>
    // Â¢ûÂº∫ÁâàARÁ≥ªÁªü
    const ARSystem = {
      scene: null,
      camera: null,
      renderer: null,
      mixer: null,
      fox: null,
      isActive: false,
      statusElement: document.getElementById('status-text'),
      arContainer: document.getElementById('ar-container'),
      notification: document.getElementById('notification'),
      
      // ÂàùÂßãÂåñThree.js
      initThree: function() {
        this.updateStatus("ü¶ä Initializing AR environment...");
        
        // ÂàõÂª∫Âú∫ÊôØ
        this.scene = new THREE.Scene();
        this.scene.background = new THREE.Color(0x0a192f);
        this.scene.fog = new THREE.Fog(0x0a192f, 10, 20);
        
        // ÂàõÂª∫Áõ∏Êú∫
        this.camera = new THREE.PerspectiveCamera(
          70, 
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        this.camera.position.set(0, 1, 5);
        
        // ÂàõÂª∫Ê∏≤ÊüìÂô®
        const canvas = document.getElementById('three-canvas');
        this.renderer = new THREE.WebGLRenderer({ 
          canvas, 
          antialias: true,
          alpha: true
        });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.setPixelRatio(window.devicePixelRatio);
        
        // Ê∑ªÂä†ÁÅØÂÖâ
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        this.scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(3, 5, 2);
        directionalLight.castShadow = true;
        this.scene.add(directionalLight);
        
        // Ê∑ªÂä†ÁéØÂ¢ÉÂÖâ
        const hemisphereLight = new THREE.HemisphereLight(0xffffbb, 0x080820, 0.5);
        this.scene.add(hemisphereLight);
        
        // Ê∑ªÂä†ÁÆÄÂçïÂú∞Èù¢
        const groundGeometry = new THREE.PlaneGeometry(20, 20);
        const groundMaterial = new THREE.MeshStandardMaterial({ 
          color: 0x1e3d59,
          roughness: 0.8,
          metalness: 0.2
        });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = -1;
        this.scene.add(ground);
        
        this.updateStatus("ü¶ä AR environment ready");
      },
      
      // Âä†ËΩΩÁãêÁã∏Ê®°Âûã
      loadFoxModel: function() {
        this.updateStatus("ü¶ä Loading virtual companion...");
        
        return new Promise((resolve) => {
          // ‰∏¥Êó∂‰ΩøÁî®Á´ãÊñπ‰Ωì‰Ωú‰∏∫Âç†‰ΩçÁ¨¶
          const geometry = new THREE.BoxGeometry(0.8, 0.8, 0.8);
          const material = new THREE.MeshPhongMaterial({ 
            color: 0xFF6B6B,
            emissive: 0x772222,
            shininess: 100,
            wireframe: true
          });
          
          this.fox = new THREE.Mesh(geometry, material);
          this.fox.position.set(0, 0, 0);
          this.scene.add(this.fox);
          
          this.updateStatus("ü¶ä Placeholder model loaded");
          resolve();
          
          // ÁúüÂÆûÊ®°ÂûãÂä†ËΩΩ‰ª£Á†ÅÔºàÊõøÊç¢Âç†‰ΩçÁ¨¶Ôºâ
          /*
          const loader = new THREE.GLTFLoader();
          loader.load('wolvic_3d_model.glb', (gltf) => {
            this.fox = gltf.scene;
            this.fox.scale.set(0.5, 0.5, 0.5);
            this.fox.position.set(0, -1, 0);
            this.scene.add(this.fox);
            
            if (gltf.animations.length > 0) {
              this.mixer = new THREE.AnimationMixer(this.fox);
              this.mixer.clipAction(gltf.animations[0]).play();
            }
            
            this.updateStatus("ü¶ä Virtual companion loaded");
            resolve();
          }, undefined, (error) => {
            console.error("Ê®°ÂûãÂä†ËΩΩÂ§±Ë¥•:", error);
            this.updateStatus("‚ö†Ô∏è Failed to load model");
            resolve();
          });
          */
        });
      },
      
      // ÂêØÂä®ÊëÑÂÉèÂ§¥ÂíåÊâãÈÉ®ËøΩË∏™
      startCameraAndTracking: function() {
        this.updateStatus("üëã Initializing hand tracking...");
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          this.updateStatus("‚ö†Ô∏è Browser doesn't support camera");
          return;
        }
        
        // ÂàõÂª∫ÊâãÈÉ®ËøΩË∏™Âô®
        const hands = new window.Hands({
          locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
          }
        });
        
        hands.setOptions({
          maxNumHands: 1,
          modelComplexity: 1,
          minDetectionConfidence: 0.7,
          minTrackingConfidence: 0.7
        });
        
        hands.onResults((results) => {
          if (!this.isActive || !this.fox) return;
          
          if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            const indexFinger = landmarks[8]; // È£üÊåáÂ∞ñ
            
            // Â∞ÜÂùêÊ†áËΩ¨Êç¢‰∏∫Three.js‰∏ñÁïåÂùêÊ†á
            const x = (indexFinger.x - 0.5) * 4;
            const y = -(indexFinger.y - 0.5) * 4 + 1;
            
            // ËÆ©Â∞èÁãêÁã∏ÈÄêÊ∏êÈù†ËøëÊâãÊåá
            this.fox.position.lerp(new THREE.Vector3(x, y, 0), 0.2);
            
            // ËÆ©ÁãêÁã∏ÁúãÂêëÊâãÊåá‰ΩçÁΩÆ
            this.fox.lookAt(x, y + 0.5, 0);
          }
        });
        
        // Ëé∑ÂèñÊëÑÂÉèÂ§¥ËÆøÈóÆÊùÉÈôê
        navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'user',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        })
        .then(stream => {
          this.updateStatus("üëã Hand tracking active");
          
          // ÂàõÂª∫ÊëÑÂÉèÂ§¥ËßÜÈ¢ëÊ∫ê
          const videoElement = document.createElement('video');
          videoElement.srcObject = stream;
          videoElement.play();
          
          // ÂêØÂä®ÊëÑÂÉèÂ§¥Â§ÑÁêÜ
          const camera = new window.Camera(videoElement, {
            onFrame: async () => {
              await hands.send({image: videoElement});
            },
            width: 640,
            height: 480
          });
          
          camera.start();
        })
        .catch(error => {
          console.error("ÊëÑÂÉèÂ§¥ËÆøÈóÆÂ§±Ë¥•:", error);
          this.updateStatus(`‚ö†Ô∏è Camera error: ${error.message}`);
        });
      },
      
      // ÊòæÁ§∫ÈÄöÁü•
      showNotification: function(message) {
        if (!this.notification) return;
        
        this.notification.innerHTML = `<span class="notification-icon">üß∏</span> ${message}`;
        this.notification.classList.add("show");
        
        setTimeout(() => {
          this.notification.classList.remove("show");
        }, 3000);
      },
      
      // ÊòæÁ§∫Êã•Êä±Âä®Áîª
      showHugAnimation: function() {
        const hugAnim = document.createElement('div');
        hugAnim.className = 'hug-animation';
        hugAnim.innerHTML = 'ü§ó';
        document.body.appendChild(hugAnim);
        
        setTimeout(() => {
          document.body.removeChild(hugAnim);
        }, 4000);
      },
      
      // ÂêØÂä®AR‰ºöËØù
      startARHugSession: function() {
        if (this.isActive) return;
        
        this.showNotification("Sending a virtual hug...");
        this.updateStatus("ü¶ä Starting virtual hug session");
        
        // ÊòæÁ§∫ARÂÆπÂô®
        this.arContainer.style.display = 'block';
        this.isActive = true;
        
        // ÂàùÂßãÂåñThree.jsÔºàÂ¶ÇÊûúÂ∞öÊú™ÂàùÂßãÂåñÔºâ
        if (!this.scene) {
          this.initThree();
        }
        
        // Âä†ËΩΩÊ®°Âûã
        this.loadFoxModel().then(() => {
          // ÂêØÂä®ÊëÑÂÉèÂ§¥ÂíåËøΩË∏™
          this.startCameraAndTracking();
          
          // ÂºÄÂßãÂä®ÁîªÂæ™ÁéØ
          this.animate();
          
          // ÊòæÁ§∫Êã•Êä±Âä®Áîª
          this.showHugAnimation();
        });
      },
      
      // ÁªìÊùüAR‰ºöËØù
      endARHugSession: function() {
        this.updateStatus("ü¶ä Session ended");
        this.arContainer.style.display = 'none';
        this.isActive = false;
      },
      
      // Êõ¥Êñ∞Áä∂ÊÄÅ
      updateStatus: function(message) {
        if (this.statusElement) {
          this.statusElement.textContent = message;
        }
      },
      
      // Âä®ÁîªÂæ™ÁéØ
      animate: function() {
        if (!this.isActive) return;
        
        requestAnimationFrame(() => this.animate());
        
        // Êõ¥Êñ∞Ê®°ÂûãÂä®Áîª
        if (this.mixer) {
          this.mixer.update(0.016);
        }
        
        // Ê∑ªÂä†ÊµÆÂä®ÊïàÊûú
        if (this.fox) {
          this.fox.position.y = 0.2 + Math.sin(Date.now() * 0.002) * 0.1;
        }
        
        // Ê∏≤ÊüìÂú∫ÊôØ
        if (this.renderer && this.scene && this.camera) {
          this.renderer.render(this.scene, this.camera);
        }
      }
    };
    
    // Êö¥Èú≤ÁªôÂÖ®Â±Ä
    window.ARSystem = ARSystem;
    
    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
    window.addEventListener('DOMContentLoaded', () => {
      // ÁªëÂÆöARÊéßÂà∂ÊåâÈíÆ
      document.getElementById('end-hug').addEventListener('click', () => {
        ARSystem.endARHugSession();
        
        // Âú®ËÅäÂ§©Ê°Ü‰∏≠ÊòæÁ§∫Ê∂àÊÅØ
        const chatBox = document.getElementById('chat-box');
        const botMsg = document.createElement("div");
        botMsg.className = "message bot-message";
        botMsg.textContent = "HugBot: I hope the virtual hug made you feel better! ü¶äüíñ";
        chatBox.appendChild(botMsg);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
      
      // ÁªëÂÆöË∞ÉËØïÊåâÈíÆ
      document.getElementById('test-camera').addEventListener('click', () => {
        ARSystem.startCameraAndTracking();
      });
      
      document.getElementById('test-ar').addEventListener('click', () => {
        ARSystem.startARHugSession();
      });
      
      document.getElementById('test-notification').addEventListener('click', () => {
        ARSystem.showNotification("Test notification works perfectly!");
      });
      
      document.getElementById('test-model').addEventListener('click', () => {
        ARSystem.loadFoxModel();
      });
      
      // ËÅäÂ§©Á≥ªÁªü
      const sendBtn = document.getElementById("send-button");
      const userInput = document.getElementById("user-input");
      const chatBox = document.getElementById("chat-box");
      
      sendBtn.addEventListener("click", async () => {
        const text = userInput.value.trim();
        if (!text) return;
        
        // ÊòæÁ§∫Áî®Êà∑Ê∂àÊÅØ
        const userMsg = document.createElement("div");
        userMsg.className = "message user-message";
        userMsg.textContent = `You: ${text}`;
        chatBox.appendChild(userMsg);
        
        userInput.value = "";
        chatBox.scrollTop = chatBox.scrollHeight;
        
        // Ê£ÄÊµãÊÉÖÁª™ÂÖ≥ÈîÆËØç
        const sadWords = ['sad', 'unhappy', 'depressed', 'lonely', 'down'];
        const isSad = sadWords.some(word => text.toLowerCase().includes(word));
        
        if (isSad) {
          // ÊòæÁ§∫ËôöÊãüÊã•Êä±Ê∂àÊÅØ
          const botMsg1 = document.createElement("div");
          botMsg1.className = "message bot-message";
          botMsg1.innerHTML = "HugBot: I sense you're feeling down. Sending a virtual hug your way... üß∏";
          chatBox.appendChild(botMsg1);
          
          // ÂêØÂä®ARÁ≥ªÁªü
          setTimeout(() => {
            ARSystem.startARHugSession();
          }, 1000);
        } else {
          // ÊôÆÈÄöÂõûÂ§ç
          const responses = [
            "Thanks for sharing that with me!",
            "I'm here to listen whenever you need me.",
            "Your feelings are important to me.",
            "I'm always here for you.",
            "Let me know if you want to talk more about it."
          ];
          
          const botMsg = document.createElement("div");
          botMsg.className = "message bot-message";
          botMsg.textContent = `HugBot: ${responses[Math.floor(Math.random() * responses.length)]}`;
          chatBox.appendChild(botMsg);
        }
        
        chatBox.scrollTop = chatBox.scrollHeight;
      });
      
      // ÂàùÂßãÂä†ËΩΩThree.js
      setTimeout(() => {
        ARSystem.initThree();
      }, 1000);
    });
  </script>
</body>
</html>
